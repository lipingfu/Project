from sampe to chi2 files
histograms_sample pmcsim


add_ded.pl pmcsim Omega_m > pmcsim+Omega_m
meanvar_sample pmcsim  to get the mean of joint paras.


calculate corr_invcov. 8 bin:
perl -e '{$ARGV[0]=(184-$ARGV[0]-2)/(184-1)/0.11197; print "$ARGV[0]  \n"}' 8




cut_data_tomo.pl -b 3 e3.m3_gen.out.meanvar e3.m3_gen.EEE.cov 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25

cut_data_tomo.pl e3.m3.out.meanvar e3.m3.EEE.cov 1 2 

install yorick-yumtils  link yumtils to yorick/i/yumtils



> Btw, I would like to plot the shadow of the contours for more than one data,
> for instance, clone map3 and data map3 on the same plot. But when I do this,
> it is always complain:
>
> plot_contour2d.pl -c Lensing_map3_diag_5par/config_pmc
> Lensing_map3_diag_5par/iter_9 Clone_map3_diag_5par/iter_9

For that you have to use the R program. First, create samples of the
corresponding pmcsim files:
sample_from_pmcsimu.R

with -m MULT you can create a larger sample to reduce noise.

Then to plot:

plot_confidence.R sample_1 sample_2 ...

Check -h for more options. It's pretty slow, so you might want to use
-i 0 -j 1 to just plot two parameters.






plot_contour2d.pl -s 2 -n -k -K "diag gen map2" -c Clone_map2_5par/config_pmc Clone_map3_diag_5par/iter_9/ Clone_map3_5par_new.m3/iter_9 Clone_map2_5par/iter_19


You need either the block:

sinitial        fisher_eigen
fshift          0.2
fvar            1.5

or the following:

sinitial        file
prop_ini_name   proposal_ini

Probably you have both cases un-commented.

If you set sdead_comp to 'revive', dead components will come back. Sometimes this is good, sometimes this just increases the noise so I don't put this option often. But you can try.




about all_mean var.ps

You can see that most of the variances increase. So they start too low. The mean values tend to spread out with iterations, which means that the starting values could be further apart (in particular for Ob and Om).
So, I'd suggest for a re-run to increase fshift, maybe by a factor 2, and to increase fvar by a bit, maybe add 0.3.
If I remember, the variance increased with iterations, so it was too small to begin with
fshift controls the spread of the mean at the beginning, it's different
for the variance it's not important whether there is a spread at the beginning or not
but whether it goes in one direction with increasing iteration


If contour is too small, it means too many of the components died off.


To drop some points from data  and cov files:
ccat.pl -H Clone.e3.m3.out.4mean.meanvar > test
cut_data_tomo.pl -b 1 test Clone.e3.m3.out.4mean.cov 1




Oct 2012 Cosmo_pmc



- I forgot to change corr_invcov before running comso_PMC. Is there someway to modify the output to get correct error range?

- In principle you could change the likelihood by exp(-alpha) to account for this factor...
altough that seems to just adding a constant to chi^2, so shouldn't change anything.

Anyway, with the sampling I don't think it will work, since I guess the sampled range was too narrow.
I'm afraid you'll have to run it again...




- On beo I only ran cosmo_pmc, not the script cosmo_pmc.pl .
So you'll have to call max_post and go_fishing before by hand.





Here is the info about the covariance rescaling for config_pmc:
 Re-scale Clone covariance
# A_scale 0.902762 * 16 / 9 / 129 = 0.01244
# (Clone has 16 nearly-1-sq-deg fields and is split into 3x3=9 subfields)
# The masked fraction fr_mask should be the same for both
# n = 184*9 = 1656
# alpha = (n - p - 2) / (n - 1)
# p = 3: alpha = 0.9976126
# corr_invcov = alpha / A_scale
 I am cutting of the first scale, so p=3
and corr_invcov = 80.18





############################################################
box of yorick contour:
need make link of  /mda06/home/liping/Software/yorick-2.1/g/boxed-medaxes.gs  in the directory of running source yorick/g/work.gs


Some importants about running PMC:


compile ECOSSAT:
set the path of libguide liblmk_lapack ... those path into $LD_LIBRARY_PATH
set private path of other libs into Makefile.host

and add IFCOREDIR = -Wl,-R libpath 


in  iter_6  edit plot_contour2d.i 
    add one line before the first eps   :  plmk,0.74,0.24,width=3,color=Red




use the previous iter run to continue the new run:

cp old/proposal_fin proposal_ini

edit config_pmc:
--------------------------------
sinitial             file
prop_ini_name	          proposal_ini
#sinitial            fisher_rshift
#fshift              0.02
#fvar                1.25
nbinhist            64
-------------------------------


smooth the contour plot:
iter_6:
 more log_plot 
 /home/liping/astro/ECOSSTAT-work/bin/plot_contour2d.pl -c config_pmc -1 m1t -g -10 -C -n -T Oms8_map_R1R2_xi250

change -g -10 --> -g 10 to not print the thin lines  (20 --> 10 more smoother)
remove -n  --> plot shadow
-C use covariance file covar.fin for gaussian smoothing

========================
Calculating Fisher matrix...done
run_mcmc(mkmc.c:538)::ForwardError
  initial_proposal(mkmc.c:451)::ForwardError
    mvdens_cholesky_decomp(../tools/src/mvdens.c:241)::Error -706 (Cholesky decomposition failed)
Exiting script mkpmc.sh with 62

edit the fiser --> put small off-diagnal terms and rerun run.pmc..... but not calculate mkmc.


#######################
run Lensing + SN

1 The example of config files are in $ECOSSTAT/Demo/MC_Demo for each data set like SN, BAO (Lensing is old there )
2 make a new directory and make links for new run:
newdir_mkmc.sh dirname   it will ask you what data set you want to use
3  cd dirname   ; make link of cosmos_xxxx.par by hand such as cosmo_lens.par cosmo_SN.par (the reference ones are in /home/liping/astro/ECOSSTAT-work/Demo/cosmo_SN.par)
4 edit the config_pmc 
in the case of two data sets SN & Lensing:


### Data section ###
ndata           2
sdata           SNIa
sdata           Lensing

# SN data
datname         sne_union_marek.list
sdatformat      SNLS_firstyear
schi2mode       chi2_simple
add_logdetCov   0
model_file      cosmo_SN.par
sspecial        none


# Lensing data
slensdata          xipm
sformat            angle_center
datname            xi_rebin
covname            xi_rebin.cov
corr_invcov        0.51
Nexclude           0
model_file         cosmo_lens.par
sspecial           none

5 run mkpmc.pl -n -p 1 -c config_pmc -f "fid values..."
then the config_max has random starting point, if it is not good, then endit it by hand and change as 
sstart  fid 
fid   par1 par2 .....  (the given paramter values like sigma8 = 0.8 omegam = 0.3...)

6 if the fisher is not made, it is better to set -f when run mkpmc.pl  
  if the fisher off diagnal is too big, the mkpmc will stop. a--> change the large off diagnal term of fisher to small by hand   b--> edit config_fish  sinitial        Fisher_diag




[20:12:12] Martin Kilbinger: neff_proposal.pl proposal_1
[20:12:27] Liping Fu: beo% PMC/Lensing+wmap7DistPrior+SN+BAO ] neff_proposal.pl proposal_1
# Ncomp Neff
 6      5.245
[20:12:38] Liping Fu: beo% PMC/Lensing+wmap7DistPrior+SN+BAO ] neff_proposal.pl proposal_7
# Ncomp Neff
 6      2.293
[20:12:58] Liping Fu: this neff means what?
[20:13:06] Martin Kilbinger: effective number of components
[20:13:18] Martin Kilbinger: basically the number of components with non-zero weight
[20:13:19] Liping Fu: I see. The higher the better?
[20:13:23] Martin Kilbinger: yes
[20:13:36] Martin Kilbinger: 2.2 means only 2 components survived until the end
[20:13:36] Liping Fu: why does it go down with iter?
[20:13:46] Martin Kilbinger: do you have the file proposal_means.ps?
[20:14:38] Liping Fu: I am not using the mkpmc.pl to run the program. What file to make this plot?
[20:15:41] Martin Kilbinger: proposal_mean.pl


> I also feel quit strange when I see mean_6 errors. So when the cf value is
> negative, it means something wrong with the parameters?
 
Usually it means that the boundary is too close, and the 68% density
is not reached before the boundary. But this seems not the case here.
Then something could have gone wrong, although from the contours it
looks alright.

If you run plot_contour2d.pl with -1 mt1, it will plot and write the
mean and error in the plots. Also I think, text files should be
produced, likeli1d_x.txt or so. You can see what's the output there. It is based
on the histogram, so less accurate, but maybe we find some more
reasonable values there.
 

> ha, it was 0. I change it to 10 then. But what does it mean  nclipw =10?
 
aaaaaahhhh long story....
It discards the 10 points with the largest weights. Those importance weights are
posterior/proposal. Although mathematically all points should be taken
into account, it happens that there are a few points with very low
proposal density. They then dominate the posterior and it is better to
get rid of those points.


max_post -m a -t
 -t makes a small peak-check at the end

---------------------
If you have initial proposal, you could continue the mkpmc running after modifiying the config_pmc


sinitial        file
prop_ini_name   proposal_ini

#sinitial        fisher_rshift
#fshift          0.05
#fvar            1.3
# End proposal

----------------------

If you have run mkpmc for wmap7 for example, then you can run importance_sample to run likelihood for other dataset ie lensing, it will mutiply the likelihood of lensing with the one of wmap7;  The configue file should edit as ndata 1, lensing (no need to put wmap; do it as only run for lensing)

mkdir new
ln -sf lensing par files to new
ln -sf wmap/pmcsim_6  .
use the npar section of config_pmc from wap, but the lensing data section from lensing

$ECOSSTAT/exec/importance_sample -c config_pmc -o pmcsim.out pmcsim_6 
where pmcsim_6 is wmap7's results,  pmcsim.out is the output


ploting
 histograms_sample pmcsim.out 
 ln -sf . iter_0
 mkdir remap
...........



plot_contour2d.pl -1 mt1 -c ../config_pmc -g -10 -n -C




 cd combine_Lensing_5par+wmap7_MK_9_plus_SZ/


plot_contour2d.pl -n -s2 -w 2 -C -g "-100 -30 -100" -c ../Lensing_5par/config_pmc -n -k -K "CMB Lens CMB+Lens" -1 m ../wmap7_MK_9_plus_SZ/remap/ ../Lensing_5par/iter_9/ remap/


# -s2 is to plot 2sig instead of 3sig
---------------

The np of cpu of runing go_fishing should not be larger than the number of parameters of the fisher matrix. If it is Fish_diag, then it is the number of parameters, if it is all matrix, then it is all (half due to the symetric) matrix element.




#### remapping
If you have different runs with different data sets, you want to plot only sigma8 omegam, you should remap all runs.

cd cmd
mkdir remap
cd remap
echo 1 5 > remap.dat
remap.sh -c ../config_pmc -j 6 -i .. -o . -r remap.dat

do the same for other dataset
for the combined dir: do ln -sf . iter_0
remap.sh -c ../config_pmc -j 0 -i .. -o . -r remap.dat

/home/liping/astro/ECOSSTAT-work/bin/plot_contour2d.pl -c config_pmc -n -k -1 m cmb/remap/ cmb+lensing/remap Lensing_5par/remap/

plot_contour2d.pl -s2 -w 2 -C -g "-100 -30 -100" -c ../Lensing_5par/config_pmc -n -k -K "CMB Lens CMB+Lens" -1 m ../wmap7_MK_9_plus_SZ/remap/ ../Lensing_5par/iter_9/ remap/


##########



Add gaussian proir on certain parameter:
make a fake fisher for certain parameter :
 more h_0.72pm0.025
1 -1 1 0
0.72
0.000625


fisher_to_meanvar.sh ~/sicher/Planck/tomo/h_0.72pm0.025 noinv       to check whether the center and error is right.

change the config_pmc

sprior          h_0.72pm0.025
nprior          1
indprior        0 0 1 0 0



#### RR

rebin.pl  -l lin/log but  depends on the xi file (from config_tree). 

EB_chi2 REB_chi2   for xi_var, set islog = 0 or 1 accordingingly.
 


making  covar+ded.fin  for plotting.

  meanvar_sample  pmcsim_x


---------------
number of lines should be nsample - nclipw.

For the combined sample, you should set niter = 1, fsfinal = 1 and nsample = 100000 or something similarly large.

-S             All contours with solid lines

and maybe -w 4 for thicker lines. Also, you can use different color schemes with
-F 1 or -F 2 (undocumented ;-))



Software install:

l_cprof_p_11.1.080
l_fcompxe_intel64_2013.0.079.tgz


To get a plot with a box, copy the attached file into the directory
XXX/yorick/YYY/g.
I don't know the exact path in your case. It's where all the .gs files
are. Then do a link
work.gs -> boxed-medaxes.gs
